<!-- 引入 文件 -->
<link rel="stylesheet" href="./leaflet.css" />
<script src="./leaflet.js"> </script>
<script type="text/javascript" src="index.js"></script>
<!-- 增加地图高度 -->
<style>
         #label{
                left: 0;
                top: 0;
                height: 30px;
                width: 300px;
        } 
         #mapDiv {
                left: 20px;
                height: 800px;
                width: 1800px
        }
/*
        #files {
                height: 20px;
                width: 200px;
        }

        #btopen {
                height: 30px;
                width: 80px;
        } */

       
</style>
<!-- 创建一个 地图的div id 必须有 但是自定义 -->
<div id="mapDiv"></div>
<!-- <input id="files" multiple="multiple" />
<input id="choose" type="file" />
<input id="btopen" type="button" value="Load" />
<input id="httpget" type="button" value="http" /> -->
<input id = "label" value="单击添加路径点,Ctrl+单击终止点"/>
<script>
        //到 mapbox 官网注册并创建下面的access token都是免费的，不过有5w次的浏览限制
        var url = 'https://a.tile.openstreetmap.de/{z}/{x}/{y}.png';
        //初始化 地图
        var leafletMap = L.map('mapDiv').setView([45, 123], 5);

        //将图层加载到地图上，并设置最大的聚焦还有map样式
        L.tileLayer(url, {
                zoom: 15
        }).addTo(leafletMap);

        leafletMap.panTo([52.517882, 13.386342]);
        leafletMap.setZoom(15);

        //文件读取
        // var btn = document.getElementById('btopen');
        // btn.onclick = function () {
        //         var selectedFile = document.getElementById('choose').files[0];
        //         if(selectedFile == null)
        //                 return;
        //         var name = selectedFile.name; //读取选中文件的文件名
        //         var size = selectedFile.size; //读取选中文件的大小

        //         var reader = new FileReader();
        //         reader.readAsText(selectedFile);
        //         reader.onload = function (e) {
        //                 var text = reader.result;
        //                 var json = JSON.parse(text);
        //                 for (var i = 0; i < json.coordinates.length; i++) {
        //                         var item = new Array();
        //                         var v = json.coordinates[i].toString().split(',');
        //                         item[0] = parseFloat(v[1]);
        //                         item[1] = parseFloat(v[0]);
        //                         routes[i] = item;
        //                 }
        //                 L.polyline(routes, { opacity: 1, color: 'green', weight: 10 }).addTo(leafletMap);
        //         }
        // }        

        // L.marker(L.latLng(52.517037, 13.388860)).addTo(leafletMap).bindPopup(L.latLng(52.517037, 13.388860).toString()).openPopup();
        // L.marker(L.latLng(52.523219, 13.428555)).addTo(leafletMap).bindPopup(L.latLng(52.523219, 13.428555).toString()).openPopup();
        // L.marker(L.latLng(52.523215, 13.418555)).addTo(leafletMap).bindPopup(L.latLng(52.523215, 13.418555).toString()).openPopup();
        // L.marker(L.latLng(52.529407, 13.397634)).addTo(leafletMap).bindPopup(L.latLng(52.529407, 13.397634).toString()).openPopup();

        var routes = new Array();
        //为点击地图的事件 增加popup
        var popup = L.popup();
        var pts = new Array();
        // latlng[0] = L.latLng(52.529407, 13.397634);
        // alert(latlng[0].lat.toString());

        const greenHtmlStyles = `
                                background-color: #11ee70;
                                width: 2rem;
                                height: 2rem;
                                display: block;
                                left: -1rem;
                                top: -1rem;
                                position: relative;
                                border-radius: 3rem 3rem 0;
                                transform: rotate(45deg);
                                border: 1px solid #FFFFFF`;

        const greenIcon = L.divIcon({
                className: "my-custom-pin",
                iconAnchor: [0, 24],
                labelAnchor: [-6, 0],
                popupAnchor: [0, -36],
                html: `<span style="${greenHtmlStyles}" />`
        });

        const blueHtmlStyles = `
                                background-color: #1107ee;
                                width: 2rem;
                                height: 2rem;
                                display: block;
                                left: -1rem;
                                top: -1rem;
                                position: relative;
                                border-radius: 3rem 3rem 0;
                                transform: rotate(45deg);
                                border: 1px solid #FFFFFF`;

        const blueIcon = L.divIcon({
                className: "my-custom-pin",
                iconAnchor: [0, 24],
                labelAnchor: [-6, 0],
                popupAnchor: [0, -36],
                html: `<span style="${blueHtmlStyles}" />`
        });

        const redHtmlStyles = `
                                background-color: #ee1107;
                                width: 2rem;
                                height: 2rem;
                                display: block;
                                left: -1rem;
                                top: -1rem;
                                position: relative;
                                border-radius: 3rem 3rem 0;
                                transform: rotate(45deg);
                                border: 1px solid #FFFFFF`;

        const redIcon = L.divIcon({
                className: "my-custom-pin",
                iconAnchor: [0, 24],
                labelAnchor: [-6, 0],
                popupAnchor: [0, -36],
                html: `<span style="${redHtmlStyles}" />`
        });
        var coords="";
        function onMapClick(e) {
                if (e.originalEvent.ctrlKey) {//ctrl 添加终点
                        L.marker(e.latlng, { icon: redIcon }).addTo(leafletMap).bindPopup(e.latlng.toString()).openPopup();
                        pts.push(e.latlng);
                        for(var i = 0; i < pts.length;++i)
                        {
                                var  temp = pts[i].lng.toString() + "," + pts[i].lat.toString();
                                if(i != (pts.length - 1))
                                        temp += ";";
                                        coords += temp;
                        }
                        GetRoute();
                }
                else {
                        L.marker(e.latlng, (pts.length < 1) ? { icon: greenIcon } : { icon: blueIcon }).addTo(leafletMap).bindPopup(e.latlng.toString()).openPopup();
                        pts.push(e.latlng);
                }
        }


        function onMapDoubleClick(e) {


        }
        leafletMap.on('click', onMapClick);
        leafletMap.on("dblclick", onMapDoubleClick);

        const routehead = "http://127.0.0.1:5000/trip/v1/driving/";


        //const coords = "13.388860,52.517037;13.397634,52.529407;13.428555,52.523219;13.418555,52.523215";

        const suffix = "?source=first&destination=last&roundtrip=false&geometries=geojson";

        
        var btnhttp = document.getElementById('httpget');
        // btnhttp.onclick = function () {
        function GetRoute(){
                var routeurl = routehead + coords + suffix;
                const http = require('http');

                http.get(routeurl, (res) => {
                        const { statusCode } = res;
                        const contentType = res.headers['content-type'];

                        let error;
                        if (statusCode !== 200) {
                                error = new Error("Request error.\n" + 'errorcode:${statusCode}');
                        }
                        if (error) {
                                alert(error.message);
                                res.resume();
                                return;
                        }

                        res.setEncoding('utf8');
                        let rawData = "";
                        res.on('data', (chunk) => { rawData += chunk; });
                        res.on('end', () => {
                                try {
                                        const parsedData = JSON.parse(rawData);
                                        if (parsedData.code !== "Ok") {
                                                alert("data error.");
                                                return;
                                        }
                                        var geoms = parsedData.trips[0].geometry.coordinates;
                                        for (var i = 0; i < geoms.length; i++) {
                                                var item = new Array();
                                                var v = geoms[i].toString().split(',');
                                                item[0] = parseFloat(v[1]);
                                                item[1] = parseFloat(v[0]);
                                                routes[i] = item;
                                        }
                                        L.polyline(routes, { opacity: 1, color: 'green', weight: 10 }).addTo(leafletMap);
                                } catch (e) {
                                        alert(e.message);
                                }
                        });
                }).on('error', (e) => { alert(e.message); });
        }
</script>