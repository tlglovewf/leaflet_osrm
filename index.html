<!-- 引入 文件 -->
<link rel="stylesheet" href="./leaflet.css" />
<script src="./leaflet.js"> </script>
<script type="text/javascript" src="index.js"></script>
<script type="text/javascript" src="style.js"></script>
<!-- 增加地图高度 -->
<style>
        #mapDiv {
                height: 90%;
                width: 100%
        }
         #label{
                left: 0;
                top: 0;
                height: 30px;
                width: 300px;
                color: #ff0000;
        } 
     
       #clear {
               left: 350px;
               height: 30px;
               width: 60px;
       }
</style>
<!-- 创建一个 地图的div id 必须有 但是自定义 -->
<div id="mapDiv"></div>
<input id = "label" value="单击添加路径点,Ctrl+单击终止点"/>
<input id = "clear" type="button"  value="Clear"/>
<script>
        // const routehead = "http://127.0.0.1:5000/trip/v1/driving/";
        const routehead = "http://router.project-osrm.org/trip/v1/driving/"
        var  coords = "";
        const suffix = "?source=first&destination=last&roundtrip=false&geometries=geojson";

        //到 mapbox 官网注册并创建下面的access token都是免费的，不过有5w次的浏览限制
        var url = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        //初始化 地图
        var leafletMap = L.map('mapDiv').setView([52.517882, 13.386342],15);

        //将图层加载到地图上，并设置最大的聚焦还有map样式
        L.tileLayer(url).addTo(leafletMap);

        var pts = new Array();
        var needclear = false;

        var btnclear = document.getElementById('clear');

        btnclear.onclick =function(){
                for(var i = 0; i < marks.length; ++i)
                {
                        marks[i].remove();
                }
                coords = "";
                pts = [];
                needclear = false;
        };

        var marks = [];
        function onMapClick(e) {
                if (e.originalEvent.ctrlKey) {//ctrl 添加终点
                        if(pts.length < 1)
                                return;
                        marks.push(L.marker(e.latlng, {icon : redIcon}).addTo(leafletMap));
                        pts.push(e.latlng);
                        for(var i = 0; i < pts.length;++i)
                        {
                                var  temp = pts[i].lng.toString() + "," + pts[i].lat.toString();
                                if(i != (pts.length - 1))
                                        temp += ";";
                                        coords += temp;
                        }
                        GetRoute();
                        needclear = true;
                }
                else {
                        if(needclear)
                        {
                                var ret = confirm("确定清空重新添加么？");
                                if(!ret)
                                   return;
                                else 
                                   btnclear.click()
                        }
                                
                        marks.push(L.marker(e.latlng, (pts.length < 1) ? { icon: greenIcon } : { icon: blueIcon }).addTo(leafletMap));
                        pts.push(e.latlng);
                }
        }


        function onMapDoubleClick(e) {
        

        }
        leafletMap.on('click', onMapClick);
        leafletMap.on("dblclick", onMapDoubleClick);
        
     

        function GetRoute(){
                var routes = new Array();
                var routeurl = routehead + coords + suffix;
                const http = require('http');

                http.get(routeurl, (res) => {
                        const { statusCode } = res;
                        const contentType = res.headers['content-type'];

                        let error;
                        if (statusCode !== 200) {
                                error = new Error("Request error.\n" + 'errorcode:${statusCode}');
                        }
                        if (error) {
                                alert(error.message);
                                res.resume();
                                return;
                        }

                        res.setEncoding('utf8');
                        let rawData = "";
                        res.on('data', (chunk) => { rawData += chunk; });
                        res.on('end', () => {
                                try {
                                        const parsedData = JSON.parse(rawData);
                                        if (parsedData.code !== "Ok") {
                                                alert("data error.");
                                                return;
                                        }
                                        var geoms = parsedData.trips[0].geometry.coordinates;
                                        for (var i = 0; i < geoms.length; i++) {
                                                var item = new Array();
                                                var v = geoms[i].toString().split(',');
                                                item[0] = parseFloat(v[1]);
                                                item[1] = parseFloat(v[0]);
                                                routes[i] = item;
                                        }
                                        marks.push(L.polyline(routes, { opacity: 1, color: 'green', weight: 10 }).addTo(leafletMap));
                                } catch (e) {
                                        alert(e.message);
                                }
                        });
                }).on('error', (e) => { alert(e.message); });
        }
</script>